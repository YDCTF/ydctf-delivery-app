<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일회성 배달 앱</title>
    <!-- Tailwind CSS 로딩 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK 로딩 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 전역 변수로 Firebase 서비스 초기화 (Canvas 환경에서 제공)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let requestsCollectionRef = null;
        let unsubscribe = null; // onSnapshot 구독 해제를 위한 변수

        // Firebase 초기화 및 인증
        async function initializeFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 인증 상태 변경 감지
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // 사용자가 로그인된 경우 (익명 로그인 포함)
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `사용자 ID: ${userId}`;
                        requestsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/requests`);
                        
                        // 기존 onSnapshot 구독이 있다면 해제
                        if (unsubscribe) {
                            unsubscribe();
                        }
                        // Firestore에서 요청 실시간으로 가져오기
                        const q = query(requestsCollectionRef);
                        unsubscribe = onSnapshot(q, (snapshot) => {
                            const fetchedRequests = [];
                            snapshot.forEach((doc) => {
                                fetchedRequests.push({ id: doc.id, ...doc.data() });
                            });
                            window.deliveryRequests = fetchedRequests; // 전역 변수에 저장
                            renderRequests(); // 요청 목록 다시 그리기
                            window.cleanOldRequests(); // 오래된 요청 삭제
                        }, (error) => {
                            console.error("Firestore snapshot error:", error);
                            showMessage("데이터 로딩 중 오류가 발생했습니다.", 3000);
                        });

                    } else {
                        // 사용자가 없는 경우 익명 로그인 시도
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Anonymous Auth Error:", error);
                            showMessage("인증에 실패했습니다. 다시 시도해주세요.", 3000);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage("앱 초기화 중 오류가 발생했습니다.", 3000);
            }
        }

        initializeFirebaseAndAuth();

        // ** 전역 변수와 함수를 window 객체에 연결하여 HTML 스크립트에서 접근 가능하도록 함 **
        window.db = db;
        window.auth = auth;
        window.userId = userId; // 초기값은 null이지만, onAuthStateChanged에서 업데이트됨
        window.requestsCollectionRef = requestsCollectionRef; // 초기값은 null이지만, onAuthStateChanged에서 업데이트됨
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.onSnapshot = onSnapshot;

        // 다른 JS 함수들이 Firebase 전역 변수를 사용할 수 있도록 별도의 스크립트 블록에 둠
    </script>

    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* 회색 배경 */
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px; /* 둥근 모서리 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
        }
        .btn-primary {
            background-color: #4f46e5; /* 보라색 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* 진한 보라색 */
        }
        .btn-secondary {
            background-color: #6b7280; /* 회색 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* 진한 회색 */
        }
        .btn-success {
            background-color: #10b981; /* 초록색 */
            color: white;
        }
        .btn-success:hover {
            background-color: #059669; /* 진한 초록색 */
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-sizing: border-box; /* 패딩이 너비에 포함되도록 */
        }
        .card {
            background-color: #f9fafb; /* 카드 배경색 */
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        /* 로딩 스피너 스타일 */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            text-align: center;
        }
        /* 비밀번호 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">일회성 배달 앱</h1>
        <p id="userIdDisplay" class="text-sm text-gray-500 text-center mb-4">사용자 ID: 로딩 중...</p>

        <div class="flex justify-center mb-6 space-x-4">
            <button id="showRequestFormBtn" class="btn btn-primary">배달 요청하기</button>
            <button id="showDeliveryListBtn" class="btn btn-secondary">요청 목록 보기 (배달원)</button>
        </div>

        <!-- 배달 요청 폼 -->
        <div id="requestForm" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">새로운 배달 요청</h2>
            <div class="mb-4">
                <label for="itemDescription" class="block text-gray-700 text-sm font-bold mb-2">무엇을 배달할까요?</label>
                <input type="text" id="itemDescription" class="input-field" placeholder="예: 편의점 컵라면, 약국 감기약" required>
            </div>
            <div class="mb-4">
                <label for="pickupLocation" class="block text-gray-700 text-sm font-bold mb-2">픽업 주소</label>
                <input type="text" id="pickupLocation" class="input-field" placeholder="예: 서울시 강남구 역삼동 스타벅스" required>
            </div>
            <div class="mb-4">
                <label for="deliveryLocation" class="block text-gray-700 text-sm font-bold mb-2">배달 주소</label>
                <input type="text" id="deliveryLocation" class="input-field" placeholder="예: 서울시 강남구 테헤란로 123 아파트" required>
            </div>
            <div class="mb-4">
                <label for="contactInfo" class="block text-gray-700 text-sm font-bold mb-2">연락처 (선택 사항)</label>
                <input type="text" id="contactInfo" class="input-field" placeholder="예: 010-1234-5678">
            </div>
            <button id="submitRequestBtn" class="btn btn-primary w-full">요청 제출하기</button>
        </div>

        <!-- 요청 목록 (배달원용) -->
        <div id="deliveryList" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">현재 배달 요청 목록</h2>
            <div id="requestsContainer" class="space-y-4">
                <!-- 요청이 여기에 동적으로 추가됩니다 -->
                <p id="noRequestsMessage" class="text-gray-500 text-center">현재 배달 요청이 없습니다.</p>
            </div>
        </div>
    </div>

    <!-- 메시지 박스 -->
    <div id="messageBox" class="message-box"></div>
    <div id="loadingSpinner" class="hidden flex justify-center items-center fixed inset-0 bg-gray-700 bg-opacity-75 z-50">
        <div class="spinner"></div>
    </div>

    <!-- 비밀번호 입력 모달 -->
    <div id="passwordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">배달원 비밀번호 입력</h3>
            <input type="password" id="passcodeInput" class="input-field mb-4" placeholder="비밀번호를 입력하세요">
            <button id="submitPasscodeBtn" class="btn btn-primary w-full mb-2">확인</button>
            <button id="cancelPasscodeBtn" class="btn btn-secondary w-full">취소</button>
        </div>
    </div>

    <script type="module">
        // 요청 데이터를 저장할 배열 (Firestore에서 가져온 데이터로 채워짐)
        window.deliveryRequests = []; // 전역으로 접근 가능하게 window에 할당

        // DOM 요소 가져오기
        const requestForm = document.getElementById('requestForm');
        const deliveryList = document.getElementById('deliveryList');
        const showRequestFormBtn = document.getElementById('showRequestFormBtn');
        const showDeliveryListBtn = document.getElementById('showDeliveryListBtn');
        const submitRequestBtn = document.getElementById('submitRequestBtn');
        const requestsContainer = document.getElementById('requestsContainer');
        const noRequestsMessage = document.getElementById('noRequestsMessage');
        const messageBox = document.getElementById('messageBox');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const passwordModal = document.getElementById('passwordModal');
        const passcodeInput = document.getElementById('passcodeInput');
        const submitPasscodeBtn = document.getElementById('submitPasscodeBtn');
        const cancelPasscodeBtn = document.getElementById('cancelPasscodeBtn');

        // 배달원 비밀번호 (임시로 하드코딩)
        const DELIVERY_PASSCODE = "7777"; 

        // 메시지 박스 표시 함수
        function showMessage(message, duration = 2000) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // 로딩 스피너 표시/숨김 함수
        function toggleLoadingSpinner(show) {
            loadingSpinner.classList.toggle('hidden', !show);
        }

        // 페이지 뷰 변경 함수
        function showView(viewId) {
            requestForm.classList.add('hidden');
            deliveryList.classList.add('hidden');
            showRequestFormBtn.classList.remove('btn-primary');
            showRequestFormBtn.classList.add('btn-secondary');
            showDeliveryListBtn.classList.remove('btn-primary');
            showDeliveryListBtn.classList.add('btn-secondary');

            if (viewId === 'requestForm') {
                requestForm.classList.remove('hidden');
                showRequestFormBtn.classList.remove('btn-secondary');
                showRequestFormBtn.classList.add('btn-primary');
            } else if (viewId === 'deliveryList') {
                deliveryList.classList.remove('hidden');
                showDeliveryListBtn.classList.remove('btn-secondary');
                showDeliveryListBtn.classList.add('btn-primary');
                window.renderRequests(); // 요청 목록을 다시 그림
            }
        }

        // 초기 뷰 설정 (Firebase 초기화 후 onAuthStateChanged에서 onSnapshot이 데이터를 가져옴)
        showView('requestForm');

        // 이벤트 리스너
        showRequestFormBtn.addEventListener('click', () => showView('requestForm'));
        
        // '요청 목록 보기' 버튼 클릭 시 비밀번호 모달 표시
        showDeliveryListBtn.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
            passcodeInput.value = ''; // 비밀번호 입력 필드 초기화
            passcodeInput.focus(); // 입력 필드에 포커스
        });

        // 비밀번호 확인 버튼 클릭 이벤트
        submitPasscodeBtn.addEventListener('click', () => {
            if (passcodeInput.value === DELIVERY_PASSCODE) {
                passwordModal.classList.add('hidden');
                showView('deliveryList'); // 비밀번호 맞으면 목록 표시
            } else {
                showMessage("비밀번호가 올바르지 않습니다.", 2000);
                passcodeInput.value = ''; // 비밀번호 초기화
            }
        });

        // 비밀번호 모달 취소 버튼 클릭 이벤트
        cancelPasscodeBtn.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            showView('requestForm'); // 취소하면 요청 폼으로 돌아감
        });

        // 요청 제출 버튼 클릭 이벤트
        submitRequestBtn.addEventListener('click', async () => {
            if (!window.requestsCollectionRef) { // Firebase 초기화 확인
                showMessage("앱이 로딩 중입니다. 잠시 후 다시 시도해주세요.", 2000);
                return;
            }

            const itemDescription = document.getElementById('itemDescription').value;
            const pickupLocation = document.getElementById('pickupLocation').value;
            const deliveryLocation = document.getElementById('deliveryLocation').value;
            const contactInfo = document.getElementById('contactInfo').value;

            if (!itemDescription || !pickupLocation || !deliveryLocation) {
                showMessage("모든 필수 정보를 입력해주세요.");
                return;
            }

            toggleLoadingSpinner(true); // 로딩 스피너 표시

            try {
                const newRequest = {
                    itemDescription,
                    pickupLocation,
                    deliveryLocation,
                    contactInfo: contactInfo || '정보 없음',
                    status: '대기 중', // 초기 상태
                    createdAt: Date.now() // 요청 생성 시 타임스탬프 추가
                };
                await window.addDoc(window.requestsCollectionRef, newRequest);

                // 입력 필드 초기화
                document.getElementById('itemDescription').value = '';
                document.getElementById('pickupLocation').value = '';
                document.getElementById('deliveryLocation').value = '';
                document.getElementById('contactInfo').value = '';

                showMessage("배달 요청이 성공적으로 제출되었습니다!");
                showView('requestForm'); // 요청 제출 후에는 요청 폼으로 유지 (사용자 편의상)
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("요청 제출 중 오류가 발생했습니다.", 3000);
            } finally {
                toggleLoadingSpinner(false); // 로딩 스피너 숨김
            }
        });

        // 요청 목록 렌더링 함수
        window.renderRequests = function() {
            requestsContainer.innerHTML = ''; // 기존 목록 초기화

            if (!window.deliveryRequests || window.deliveryRequests.length === 0) {
                noRequestsMessage.classList.remove('hidden');
                requestsContainer.appendChild(noRequestsMessage);
                return;
            } else {
                noRequestsMessage.classList.add('hidden');
            }

            // 최신 요청이 상단에 오도록 정렬
            const sortedRequests = [...window.deliveryRequests].sort((a, b) => b.createdAt - a.createdAt);

            sortedRequests.forEach(request => {
                const requestCard = document.createElement('div');
                requestCard.className = 'card';
                requestCard.innerHTML = `
                    <p class="font-bold text-gray-800 text-lg mb-2">${request.itemDescription}</p>
                    <p class="text-gray-600 mb-1"><strong>픽업:</strong> ${request.pickupLocation}</p>
                    <p class="text-gray-600 mb-1"><strong>배달:</strong> ${request.deliveryLocation}</p>
                    <p class="text-gray-600 mb-2"><strong>연락처:</strong> ${request.contactInfo}</p>
                    <p class="text-gray-700 font-semibold mb-3">상태: <span class="${request.status === '대기 중' ? 'text-yellow-600' : 'text-green-600'}">${request.status}</span></p>
                    <button class="btn ${request.status === '대기 중' ? 'btn-success' : 'btn-secondary opacity-50 cursor-not-allowed'}" data-id="${request.id}" ${request.status !== '대기 중' ? 'disabled' : ''}>
                        ${request.status === '대기 중' ? '배달 수락하기' : '수락 완료'}
                    </button>
                `;
                requestsContainer.appendChild(requestCard);
            });

            // 배달 수락 버튼 이벤트 리스너 추가 (목록이 렌더링될 때마다 다시 추가)
            requestsContainer.querySelectorAll('.btn-success').forEach(button => {
                button.addEventListener('click', (event) => {
                    const requestId = event.target.dataset.id; // Firestore Document ID
                    window.acceptDelivery(requestId);
                });
            });
        };

        // 배달 수락 함수
        window.acceptDelivery = async function(id) {
            if (!window.requestsCollectionRef) return; // Firebase 초기화 확인

            toggleLoadingSpinner(true); // 로딩 스피너 표시
            try {
                const requestDocRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/requests`, id);
                await window.updateDoc(requestDocRef, { status: '배달 중' });
                const acceptedRequest = window.deliveryRequests.find(req => req.id === id);
                if (acceptedRequest) {
                    showMessage(`요청 "${acceptedRequest.itemDescription}"이(가) 수락되었습니다!`);
                }
            } catch (error) {
                console.error("Error updating document: ", error);
                showMessage("요청 수락 중 오류가 발생했습니다.", 3000);
            } finally {
                toggleLoadingSpinner(false); // 로딩 스피너 숨김
            }
        };

        // 7일 지난 오래된 요청 삭제 함수
        window.cleanOldRequests = async function() { // window 객체에 할당하여 전역 접근 가능하게 함
            if (!window.requestsCollectionRef) return;

            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000); // 7일 전 타임스탬프

            try {
                const querySnapshot = await window.getDocs(window.requestsCollectionRef);
                const oldDocs = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.createdAt && data.createdAt < sevenDaysAgo) {
                        oldDocs.push(doc.id);
                    }
                });

                if (oldDocs.length > 0) {
                    console.log(`Deleting ${oldDocs.length} old requests...`);
                    for (const docId of oldDocs) {
                        const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/requests`, docId);
                        await window.deleteDoc(docRef);
                    }
                    showMessage("오래된 요청이 삭제되었습니다.", 2000);
                }
            } catch (error) {
                console.error("Error cleaning old requests:", error);
            }
        }
    </script>
</body>
</html>
